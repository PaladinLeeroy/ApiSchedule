{% include 'header.html' %}

<div class="container mt-4">
    <a href="/" class="btn btn-info mb-3 text-white">На главную</a>
    <h1 class="mb-4">Архив расписаний</h1>

    <!-- Фильтры -->
    <div class="card mb-4">
        <div class="card-body">
            <form id="filterForm" class="row g-3">
                <div class="col-md-4">
                    <label for="groupType" class="form-label">Тип группы</label>
                    <select class="form-select" id="groupType">
                        <option value="">Все типы</option>
                        <option value="Очное">Очное</option>
                        <option value="Заочное">Заочное</option>
                        <option value="Очно-заочное">Очно-заочное</option>
                        <option value="Магистратура">Магистратура</option>
                        <option value="Особая">Особая</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="scheduleType" class="form-label">Тип расписания</label>
                    <select class="form-select" id="scheduleType">
                        <option value="">Все типы</option>
                        <option value="regular">Обычное расписание</option>
                        <option value="exam">Экзаменационная неделя</option>
                        <option value="test">Зачетная неделя</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="status" class="form-label">Статус</label>
                    <select class="form-select" id="status">
                        <option value="">Все</option>
                        <option value="current">Текущие</option>
                        <option value="past">Прошедшие</option>
                        <option value="future">Будущие</option>
                    </select>
                </div>
            </form>
        </div>
    </div>

    <!-- Список расписаний -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Название</th>
                            <th>Тип группы</th>
                            <th>Тип расписания</th>
                            <th>Период</th>
                            <th>Статус</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody id="schedulesList">
                        <!-- Здесь будет список расписаний -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
    // Функция для загрузки списка расписаний
    async function loadSchedules() {
        try {
            const groupType = document.getElementById('groupType').value;
            const response = await fetch(`/api/schedule-templates${groupType ? `?group_type=${groupType}` : ''}`);
            if (!response.ok) {
                throw new Error('Ошибка при загрузке данных');
            }
            const schedules = await response.json();
            displaySchedules(schedules);
        } catch (error) {
            console.error('Ошибка при загрузке расписаний:', error);
            alert('Ошибка при загрузке расписаний');
        }
    }

    // Функция для отображения списка расписаний
    function displaySchedules(schedules) {
        const tbody = document.getElementById('schedulesList');
        tbody.innerHTML = '';

        const today = new Date();
        const statusFilter = document.getElementById('status').value;
        const scheduleTypeFilter = document.getElementById('scheduleType').value;

        schedules.forEach(schedule => {
            const startDate = new Date(schedule.date_start);
            const endDate = new Date(schedule.date_end);
            
            // Определяем статус расписания
            let status;
            if (endDate < today) {
                status = 'past';
            } else if (startDate > today) {
                status = 'future';
            } else {
                status = 'current';
            }

            // Применяем фильтры
            if (statusFilter && status !== statusFilter) return;
            if (scheduleTypeFilter && schedule.schedule_type !== scheduleTypeFilter) return;

            const row = document.createElement('tr');
            
            // Определяем текст статуса
            const statusText = {
                'past': 'Прошедшее',
                'current': 'Текущее',
                'future': 'Будущее'
            }[status];

            // Определяем тип расписания
            const scheduleTypeText = {
                'regular': 'Обычное расписание',
                'exam': 'Экзаменационная неделя',
                'test': 'Зачетная неделя'
            }[schedule.schedule_type];

            row.innerHTML = `
                <td>${schedule.name}</td>
                <td>${schedule.group_type}</td>
                <td>${scheduleTypeText}</td>
                <td>${formatDate(startDate)} - ${formatDate(endDate)}</td>
                <td>
                    <span class="badge ${getStatusBadgeClass(status)}">
                        ${statusText}
                    </span>
                </td>
                <td>
                    <a href="/view_schedule/${schedule.id}" class="btn btn-primary btn-sm">
                        <i class="fas fa-eye"></i> Просмотр
                    </a>
                    <button onclick="deleteSchedule(${schedule.id})" class="btn btn-danger btn-sm">
                        <i class="fas fa-trash"></i> Удалить
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    // Функция для форматирования даты
    function formatDate(date) {
        return date.toLocaleDateString('ru-RU');
    }

    // Функция для определения класса бейджа статуса
    function getStatusBadgeClass(status) {
        const classes = {
            'past': 'bg-secondary',
            'current': 'bg-success',
            'future': 'bg-primary'
        };
        return classes[status] || 'bg-secondary';
    }

    // Обработчики событий для фильтров
    document.getElementById('groupType').addEventListener('change', loadSchedules);
    document.getElementById('scheduleType').addEventListener('change', loadSchedules);
    document.getElementById('status').addEventListener('change', loadSchedules);

    // Функция для удаления расписания
    async function deleteSchedule(scheduleId) {
        if (!confirm('Вы уверены, что хотите удалить это расписание?')) {
            return;
        }

        try {
            const response = await fetch(`/api/schedule-templates/${scheduleId}`, {
                method: 'DELETE'
            });

            if (!response.ok) {
                throw new Error('Ошибка при удалении расписания');
            }

            // Перезагружаем список расписаний
            loadSchedules();
        } catch (error) {
            console.error('Ошибка при удалении расписания:', error);
            alert('Ошибка при удалении расписания');
        }
    }

    // Загружаем расписания при загрузке страницы
    document.addEventListener('DOMContentLoaded', loadSchedules);
</script>
{% endblock %}

{% include 'footer.html' %}