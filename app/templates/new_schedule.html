{% include 'header.html' %}

<div class="container">
    <a href="/" class="btn btn-info mb-3 text-white">На главную</a>
    <h1 class="mb-4">Создание нового расписания</h1>

    <div class="card">
        <div class="card-body">
            <form id="scheduleForm" class="needs-validation" novalidate>
                <div class="row g-3">
                    <!-- Тип группы -->
                    <div class="col-md-6">
                        <label for="groupType" class="form-label">Тип группы</label>
                        <select class="form-select" id="groupType" required>
                            <option value="" selected disabled>Выберите тип группы</option>
                            <option value="Очное">Очное</option>
                            <option value="Заочное">Заочное</option>
                            <option value="Очно-заочное">Очно-заочное</option>
                            <option value="Магистратура">Магистратура</option>
                            <option value="Особая">Особая</option>
                        </select>
                        <div class="invalid-feedback">
                            Пожалуйста, выберите тип группы
                        </div>
                    </div>

                    <!-- Тип расписания -->
                    <div class="col-md-6">
                        <label for="scheduleType" class="form-label">Тип расписания</label>
                        <select class="form-select" id="scheduleType" required>
                            <option value="" selected disabled>Выберите тип расписания</option>
                            <option value="regular">Обычное расписание</option>
                            <option value="exam">Экзаменационная неделя</option>
                            <option value="test">Зачетная неделя</option>
                        </select>
                        <div class="invalid-feedback">
                            Пожалуйста, выберите тип расписания
                        </div>
                    </div>

                    <!-- Период -->
                    <div class="col-12">
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="isFullSemester">
                            <label class="form-check-label" for="isFullSemester">
                                Расписание на весь семестр
                            </label>
                        </div>
                        <label class="form-label">Период</label>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-calendar"></i>
                                    </span>
                                    <input type="date" 
                                           class="form-control" 
                                           id="dateStart" 
                                           required
                                           min="2024-01-01"
                                           max="2030-12-31">
                                    <div class="invalid-feedback">
                                        Пожалуйста, выберите дату начала
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-calendar"></i>
                                    </span>
                                    <input type="date" 
                                           class="form-control" 
                                           id="dateEnd" 
                                           required
                                           min="2024-01-01"
                                           max="2030-12-31">
                                    <div class="invalid-feedback">
                                        Пожалуйста, выберите дату окончания
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Кнопка создания -->
                    <div class="col-12 text-end">
                        <button type="button" class="btn btn-primary" onclick="createMainTable()">
                            <i class="fas fa-table me-2"></i>Сформировать таблицу
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="scheduleTable" class="mt-4"></div>

<!-- Модальное окно для добавления/редактирования урока -->
<div class="modal fade" id="lessonModal" tabindex="-1" aria-labelledby="lessonModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="lessonModalLabel">Добавление урока</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="lessonSelect" class="form-label">Предмет</label>
                    <select class="form-select" id="lessonSelect">
                        <option value="" selected>Выберите предмет</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="lessonTypeSelect" class="form-label">Тип занятия</label>
                    <select class="form-select" id="lessonTypeSelect">
                        <option value="lecture">Лекция</option>
                        <option value="practice">Практика</option>
                        <option value="test">Зачет</option>
                        <option value="exam">Экзамен</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="roomSelect" class="form-label">Кабинет</label>
                    <select class="form-select" id="roomSelect">
                        <option value="" selected>Выберите кабинет</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="saveLessonBtn">Сохранить</button>
            </div>
        </div>
    </div>
</div>

{% block scripts %}

<script>
    const windowInnerWidth = window.innerWidth
    const windowInnerHeight = window.innerHeight
    
    // Глобальная переменная для хранения списка предметов с преподавателями
    let lessonsWithTeachers = [];
    
    // Глобальная переменная для хранения списка групп
    let groups = [];

    // Глобальная переменная для хранения списка кабинетов
    let rooms = [];
    
    // Функция для загрузки списка предметов с преподавателями
    async function loadLessonsWithTeachers() {
        try {
            const response = await fetch('/api/lessons-with-teachers');
            if (!response.ok) {
                throw new Error('Ошибка при загрузке данных');
            }
            lessonsWithTeachers = await response.json();
            console.log('Загружены предметы с преподавателями:', lessonsWithTeachers);
        } catch (error) {
            console.error('Ошибка при загрузке предметов с преподавателями:', error);
        }
    }
    
    // Функция для загрузки списка групп
    async function loadGroups() {
        try {
            const response = await fetch('/api/groups');
            if (!response.ok) {
                throw new Error('Ошибка при загрузке данных');
            }
            groups = await response.json();
            console.log('Загружены группы:', groups);
        } catch (error) {
            console.error('Ошибка при загрузке групп:', error);
        }
    }

    // Функция для загрузки списка кабинетов
    async function loadRooms() {
        try {
            const response = await fetch('/api/rooms');
            if (!response.ok) {
                throw new Error('Ошибка при загрузке данных');
            }
            rooms = await response.json();
            console.log('Загружены кабинеты:', rooms);
        } catch (error) {
            console.error('Ошибка при загрузке кабинетов:', error);
        }
    }
    
    // Загружаем данные при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
        loadLessonsWithTeachers();
        loadGroups();
        loadRooms();
    });
    
    // Добавляем валидацию формы
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('scheduleForm');
        
        // Устанавливаем минимальную дату окончания равной дате начала
        document.getElementById('dateStart').addEventListener('change', function() {
            document.getElementById('dateEnd').min = this.value;
        });

        // Валидация формы
        form.addEventListener('submit', function(event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        });
    });

    // Добавляем обработчик для чекбокса
    document.getElementById('isFullSemester').addEventListener('change', function() {
        const dateInputs = document.querySelectorAll('#dateStart, #dateEnd');
        dateInputs.forEach(input => {
            input.disabled = this.checked;
            if (this.checked) {
                input.value = '';
            }
        });
    });

    // Обновляем функцию createMainTable
    function createMainTable() {
        const form = document.getElementById('scheduleForm');
        if (!form.checkValidity()) {
            form.classList.add('was-validated');
            return;
        }

        const groupType = document.getElementById('groupType').value;
        const scheduleType = document.getElementById('scheduleType').value;
        const isFullSemester = document.getElementById('isFullSemester').checked;
        const dateStart = document.getElementById('dateStart').value;
        const dateEnd = document.getElementById('dateEnd').value;

        if (!isFullSemester) {
            // Проверяем, что дата окончания не раньше даты начала
            if (new Date(dateEnd) < new Date(dateStart)) {
                alert('Дата окончания не может быть раньше даты начала');
                return;
            }
        }

        // Создаем шаблон расписания
        createScheduleTemplate(groupType, scheduleType, dateStart, dateEnd, isFullSemester);
    }

    // Обновляем функцию createScheduleTemplate
    async function createScheduleTemplate(groupType, scheduleType, dateStart, dateEnd, isFullSemester) {
        try {
            // Формируем название шаблона
            const templateName = `${groupType} ${scheduleType} ${isFullSemester ? 'на весь семестр' : `${dateStart} - ${dateEnd}`}`;
            
            // Если расписание на весь семестр, устанавливаем текущую дату как начальную и конечную
            let startDate = dateStart;
            let endDate = dateEnd;
            
            if (isFullSemester) {
                const today = new Date();
                startDate = today.toISOString().split('T')[0];
                endDate = today.toISOString().split('T')[0];
            }
            
            const response = await fetch('/api/schedule-template', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name: templateName,
                    group_type: groupType,
                    schedule_type: scheduleType,
                    date_start: startDate,
                    date_end: endDate,
                    is_full_semester: isFullSemester
                }),
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'Ошибка при создании шаблона расписания');
            }

            const template = await response.json();
            window.currentTemplateId = template.id;
            
            // Продолжаем создание таблицы
            const scheduleContainer = document.getElementById('scheduleTable');
            scheduleContainer.innerHTML = '';

            const filteredGroups = groups.filter(group => group.type === groupType);
            
            if (filteredGroups.length === 0) {
                alert('Таких групп пока нет, добавьте их в список групп');
                return;
            }

            const table = document.createElement('table');
            table.className = 'mainTable table-bordered';

            const headerRow = document.createElement('tr');
            
            leftUpCell = document.createElement('th');
            leftUpCell.className = 'dateCell';
            headerRow.appendChild(leftUpCell);
            headerRow.appendChild(document.createElement('th'));

            filteredGroups.forEach(group => {
                const th = document.createElement('th');
                th.className = 'groupCell text-center';
                th.innerText = group.name;
                th.setAttribute('data-group-id', group.id);
                headerRow.appendChild(th);
            });
            table.appendChild(headerRow);

            const daysOfWeek = ['Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота'];
            const daysCount = isFullSemester ? 6 : Math.ceil((new Date(dateEnd) - new Date(dateStart)) / (1000 * 3600 * 24)) + 1;

            for (let day = 0; day < daysCount; day++) {
                const row = document.createElement('tr');

                const dateCell = document.createElement('td');
                dateCell.className = 'dateCell text-center';
                if (isFullSemester) {
                    dateCell.innerText = daysOfWeek[day];
                } else {
                    const currentDate = new Date(dateStart);
                    currentDate.setDate(currentDate.getDate() + day);
                    dateCell.innerText = formatDate(currentDate);
                }
                row.appendChild(dateCell);

                const lessonNumberCell = document.createElement('td');
                lessonNumberCell.className = 'coupleCell';
                for (let lesson = 1; lesson <= 7; lesson++) {
                    const divForLesson = document.createElement('div');
                    divForLesson.className = 'divForLesson text-center align-middle';
                    divForLesson.innerText = lesson;
                    lessonNumberCell.appendChild(divForLesson);
                }
                row.appendChild(lessonNumberCell);

                filteredGroups.forEach(group => {
                    const cell = document.createElement('td');
                    cell.className = 'mainTd';
                    const widthTd = (windowInnerWidth - 120) / filteredGroups.length;
                    cell.style.width = `${widthTd}px`;
                    
                    for (let lesson = 1; lesson <= 7; lesson++) {
                        const mainCell = document.createElement('div');
                        mainCell.className = 'mainCell text-center';
                        const data = `${day}_${group.id}_${lesson}`;
                        mainCell.setAttribute('data', data);

                        const btnCreateLessonNad = document.createElement('button');
                        btnCreateLessonNad.innerText = '+';
                        btnCreateLessonNad.className = 'btn_standart btnForCreateLesson btn btn-primary m-1';
                        btnCreateLessonNad.setAttribute('onclick', `createLesson('${data}', 'coupNadChertoi')`);

                        const btnCreateLessonPod = document.createElement('button');
                        btnCreateLessonPod.innerText = '+';
                        btnCreateLessonPod.className = 'btn_standart btnForCreateLesson btn btn-primary m-1';
                        btnCreateLessonPod.setAttribute('onclick', `createLesson('${data}', 'coupPodChertoi')`);

                        const coupNadChertoi = document.createElement('div');
                        coupNadChertoi.className = 'coupNadChertoi lessonCellBeforeCreateLesson align-middle text-center';
                        const coupPodChertoi = document.createElement('div');
                        coupPodChertoi.className = 'coupPodChertoi lessonCellBeforeCreateLesson align-middle text-center';

                        coupNadChertoi.appendChild(btnCreateLessonNad);
                        coupPodChertoi.appendChild(btnCreateLessonPod);

                        mainCell.appendChild(coupNadChertoi);
                        mainCell.appendChild(coupPodChertoi);

                        cell.appendChild(mainCell);
                    }

                    row.appendChild(cell);
                });

                table.appendChild(row);
            }
            scheduleContainer.appendChild(table);
        } catch (error) {
            console.error('Ошибка при создании шаблона расписания:', error);
            alert('Ошибка при создании шаблона расписания. Пожалуйста, попробуйте еще раз.');
        }
    }

    function formatDate(date) {
        return date.toISOString().split('T')[0];
    }
    
    let currentCellData = null;
    let currentCellType = null;
    let currentCell = null;
    let isEditing = false;

    function createLesson(data, type) {
        currentCellData = data;
        currentCellType = type;
        const searchMainCell = document.querySelector(`div[data="${data}"]`);
        if (!searchMainCell) {
            console.error('Не найдена ячейка с data:', data);
            return;
        }
        currentCell = searchMainCell.querySelector('.'+`${type}`);
        if (!currentCell) {
            console.error('Не найден элемент с классом:', type);
            return;
        }
        currentCell.style.backgroundColor = '#e6edeb';

        const lessonSelect = document.getElementById('lessonSelect');
        lessonSelect.innerHTML = '<option value="" selected>Выберите предмет</option>';
        lessonsWithTeachers.forEach(lesson => {
            const option = document.createElement('option');
            option.value = lesson.id;
            option.textContent = `${lesson.name} (${lesson.teacher_name})`;
            option.setAttribute('data-teacher-id', lesson.teacher_id);
            lessonSelect.appendChild(option);
        });

        const roomSelect = document.getElementById('roomSelect');
        roomSelect.innerHTML = '<option value="" selected>Выберите кабинет</option>';
        rooms.forEach(room => {
            const option = document.createElement('option');
            option.value = room.number;
            option.textContent = `${room.number} (${room.capacity} мест)`;
            roomSelect.appendChild(option);
        });

        $('#lessonSelect').select2({
            dropdownParent: $('#lessonModal'),
            placeholder: 'Поиск предмета или преподавателя',
            allowClear: true,
            language: {
                noResults: function() {
                    return "Ничего не найдено";
                },
                searching: function() {
                    return "Поиск...";
                }
            }
        });

        $('#roomSelect').select2({
            dropdownParent: $('#lessonModal'),
            placeholder: 'Поиск кабинета',
            allowClear: true,
            language: {
                noResults: function() {
                    return "Ничего не найдено";
                },
                searching: function() {
                    return "Поиск...";
                }
            }
        });

        const modal = new bootstrap.Modal(document.getElementById('lessonModal'));
        modal.show();
    }

    function editLesson(data, type) {
        isEditing = true;
        const searchMainCell = document.querySelector(`[data='${data}']`);
        const searchCell = searchMainCell.querySelector('.'+`${type}`);
        
        const lessonCell = searchCell.querySelector('.lessonCell');
        const currentLessonName = lessonCell.childNodes[0].textContent.trim();
        const currentRoom = searchCell.querySelector('.roomCell').textContent;
        const currentLessonType = lessonCell.getAttribute('data-lesson-type') || 'lecture';
        
        currentCellData = data;
        currentCellType = type;
        currentCell = searchCell;

        const lessonSelect = document.getElementById('lessonSelect');
        lessonSelect.innerHTML = '<option value="" selected>Выберите предмет</option>';
        lessonsWithTeachers.forEach(lesson => {
            const option = document.createElement('option');
            option.value = lesson.id;
            option.textContent = `${lesson.name} (${lesson.teacher_name})`;
            option.setAttribute('data-teacher-id', lesson.teacher_id);
            lessonSelect.appendChild(option);
        });

        const roomSelect = document.getElementById('roomSelect');
        roomSelect.innerHTML = '<option value="" selected>Выберите кабинет</option>';
        rooms.forEach(room => {
            const option = document.createElement('option');
            option.value = room.number;
            option.textContent = `${room.number} (${room.capacity} мест)`;
            roomSelect.appendChild(option);
        });

        $('#lessonSelect').select2({
            dropdownParent: $('#lessonModal'),
            placeholder: 'Поиск предмета или преподавателя',
            allowClear: true,
            language: {
                noResults: function() {
                    return "Ничего не найдено";
                },
                searching: function() {
                    return "Поиск...";
                }
            }
        });

        $('#roomSelect').select2({
            dropdownParent: $('#lessonModal'),
            placeholder: 'Поиск кабинета',
            allowClear: true,
            language: {
                noResults: function() {
                    return "Ничего не найдено";
                },
                searching: function() {
                    return "Поиск...";
                }
            }
        });

        const lessonParts = currentLessonName.split(' (');
        const lessonName = lessonParts[0];
        const teacherName = lessonParts[1] ? lessonParts[1].replace(')', '') : '';
        
        const matchingLesson = lessonsWithTeachers.find(l => 
            l.name === lessonName && l.teacher_name === teacherName
        );
        
        if (matchingLesson) {
            lessonSelect.value = matchingLesson.id;
            $('#lessonSelect').trigger('change');
        }
        
        const matchingRoom = rooms.find(r => r.number === currentRoom);
        if (matchingRoom) {
            roomSelect.value = matchingRoom.number;
            $('#roomSelect').trigger('change');
        }

        document.getElementById('lessonTypeSelect').value = currentLessonType;

        const modal = new bootstrap.Modal(document.getElementById('lessonModal'));
        modal.show();
    }

    document.getElementById('saveLessonBtn').addEventListener('click', async function() {
        const lessonSelect = document.getElementById('lessonSelect');
        const roomSelect = document.getElementById('roomSelect');
        const lessonTypeSelect = document.getElementById('lessonTypeSelect');
        
        if (!lessonSelect.value || !roomSelect.value) {
            alert('Пожалуйста, выберите предмет и кабинет');
            return;
        }

        if (!window.currentTemplateId) {
            alert('Ошибка: шаблон расписания не создан');
            return;
        }

        const selectedLesson = lessonsWithTeachers.find(l => l.id == lessonSelect.value);
        if (!selectedLesson) {
            alert('Ошибка: предмет не найден');
            return;
        }

        const selectedRoom = rooms.find(r => r.number === roomSelect.value);
        if (!selectedRoom) {
            alert('Ошибка: кабинет не найден');
            return;
        }

        const [day, groupId, lessonNumber] = currentCellData.split('_').map(Number);
        const isAboveLine = currentCellType === 'coupNadChertoi';
        
        const dateCell = currentCell.closest('tr').querySelector('.dateCell');
        const dateStr = dateCell.textContent;
        
        // Если это расписание на весь семестр, используем текущую дату и сохраняем день недели
        let scheduleDate = dateStr;
        let dayOfWeek = null;
        if (dateStr.match(/^(Понедельник|Вторник|Среда|Четверг|Пятница|Суббота)$/)) {
            const today = new Date();
            scheduleDate = today.toISOString().split('T')[0];
            dayOfWeek = day + 1; // day уже содержит индекс дня недели (0-5)
        }
        
        try {
            const response = await fetch('/api/schedule', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    template_id: window.currentTemplateId,
                    date: scheduleDate,
                    group_id: groupId,
                    lesson_id: parseInt(selectedLesson.id),
                    teacher_id: parseInt(selectedLesson.teacher_id),
                    room_id: selectedRoom.id,
                    lesson_number: lessonNumber,
                    is_above_line: isAboveLine,
                    lesson_type: lessonTypeSelect.value,
                    day_of_week: dayOfWeek
                }),
            });
            
            if (!response.ok) {
                const contentType = response.headers.get('content-type');
                let errorMessage = 'Ошибка при сохранении данных';
                
                if (contentType && contentType.includes('application/json')) {
                    const errorData = await response.json();
                    errorMessage = errorData.detail || errorMessage;
                } else {
                    errorMessage = await response.text();
                }
                throw new Error(errorMessage);
            }
            
            const lessonTypeText = {
                'lecture': 'Лекция',
                'practice': 'Практика',
                'test': 'Зачет',
                'exam': 'Экзамен'
            }[lessonTypeSelect.value];

            currentCell.innerHTML = `
                <div class="lessonCell" data-lesson-type="${lessonTypeSelect.value}">
                    ${selectedLesson.name} (${selectedLesson.teacher_name}) - ${lessonTypeText}
                    <button class="btn btn-sm btn-primary edit-button" onclick="editLesson('${currentCellData}', '${currentCellType}')">
                        <i class="fas fa-edit"></i>
                    </button>
                </div>
                <div class="roomCell">${roomSelect.value}</div>
            `;
            currentCell.style.backgroundColor = '';
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('lessonModal'));
            modal.hide();
            
            isEditing = false;
        } catch (error) {
            console.error('Ошибка при сохранении расписания:', error);
            alert(error.message || 'Ошибка при сохранении данных. Пожалуйста, попробуйте еще раз.');
        }
    });

    document.getElementById('lessonModal').addEventListener('hidden.bs.modal', function () {
        $('#lessonSelect').select2('destroy');
        $('#roomSelect').select2('destroy');

        if (!isEditing) {
            if (!currentCell.querySelector('.lessonCell')) {
                currentCell.innerHTML = '';
                currentCell.style.backgroundColor = '';
                const btnCreateLesson = document.createElement('button');
                btnCreateLesson.innerText = '+';
                btnCreateLesson.className = 'btn_standart btnForCreateLesson btn btn-primary m-1';
                btnCreateLesson.setAttribute('onclick', `createLesson(${currentCellData}, '${currentCellType}')`);
                currentCell.appendChild(btnCreateLesson);
            }
        }
        isEditing = false;
    });
</script>

{% endblock %}

{% include 'footer.html' %}