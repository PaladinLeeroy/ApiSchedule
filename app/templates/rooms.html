{% include 'header.html' %}

<!-- Добавляем Animate.css -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

{% block content %}
<div class="container mt-4">
    <a href="/" class="btn btn-info mb-3 text-white">На главную</a>
    <h2>Управление кабинетами</h2>
    
    <!-- Форма добавления нового кабинета -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Добавить новый кабинет</h5>
            <form id="addRoomForm">
                <div class="mb-3">
                    <label for="roomNumber" class="form-label">Номер кабинета:</label>
                    <input type="text" class="form-control" id="roomNumber" placeholder="Например: 4-2-12" required>
                </div>
                <div class="mb-3">
                    <label for="roomCapacity" class="form-label">Вместимость:</label>
                    <input type="number" class="form-control" id="roomCapacity" placeholder="Например: 30" required>
                </div>
                <div class="mb-3">
                    <label for="roomDescription" class="form-label">Описание (необязательно):</label>
                    <textarea class="form-control" id="roomDescription" rows="2" placeholder="Например: Компьютерный класс"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Добавить кабинет</button>
            </form>
        </div>
    </div>

    <!-- Таблица кабинетов -->
    <div class="card">
        <div class="card-body">
            <h5 class="card-title">Список кабинетов</h5>
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Номер</th>
                            <th>Вместимость</th>
                            <th>Описание</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody id="roomsTableBody">
                        <!-- Здесь будут отображаться кабинеты -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для редактирования -->
<div class="modal fade" id="editRoomModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Редактировать кабинет</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editRoomForm">
                    <input type="hidden" id="editRoomId">
                    <div class="mb-3">
                        <label for="editRoomNumber" class="form-label">Номер кабинета:</label>
                        <input type="text" class="form-control" id="editRoomNumber" required>
                    </div>
                    <div class="mb-3">
                        <label for="editRoomCapacity" class="form-label">Вместимость:</label>
                        <input type="number" class="form-control" id="editRoomCapacity" required>
                    </div>
                    <div class="mb-3">
                        <label for="editRoomDescription" class="form-label">Описание:</label>
                        <textarea class="form-control" id="editRoomDescription" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="saveRoomEdit">Сохранить</button>
            </div>
        </div>
    </div>
</div>

<style>
    /* Стили для уведомлений */
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
    }
    
    .toast {
        background: white;
        border-radius: 4px;
        padding: 15px 25px;
        margin-bottom: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        display: flex;
        align-items: center;
        justify-content: space-between;
        min-width: 300px;
    }
    
    .toast.success {
        border-left: 4px solid #28a745;
    }
    
    .toast.error {
        border-left: 4px solid #dc3545;
    }
    
    .toast-content {
        margin-right: 15px;
    }
    
    .toast-close {
        cursor: pointer;
        color: #6c757d;
    }
    
    /* Анимации для кабинетов */
    .room-row {
        animation: fadeIn 0.5s;
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"></script>
<script src="{{ url_for('static', path='js/animations.js') }}"></script>
<script>
// Загрузка списка кабинетов
async function loadRooms() {
    try {
        const response = await fetch('/api/rooms');
        const rooms = await response.json();
        const tbody = document.getElementById('roomsTableBody');
        tbody.innerHTML = '';
        
        rooms.forEach((room, index) => {
            const tr = document.createElement('tr');
            tr.className = 'room-row animate__animated animate__fadeIn';
            tr.style.animationDelay = `${index * 0.1}s`;
            tr.innerHTML = `
                <td>${room.number}</td>
                <td>${room.capacity}</td>
                <td>${room.description || ''}</td>
                <td>
                    <button class="btn btn-sm btn-primary me-2 edit-room" 
                            data-id="${room.id}" 
                            data-number="${room.number}" 
                            data-capacity="${room.capacity}" 
                            data-description="${room.description || ''}">
                        Редактировать
                    </button>
                    <button class="btn btn-sm btn-danger delete-room" data-id="${room.id}">
                        Удалить
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
            
            // Добавляем обработчики событий
            addEventListenersToRow(tr);
        });
    } catch (error) {
        console.error('Error loading rooms:', error);
        showToast('Ошибка при загрузке списка кабинетов', 'error');
    }
}

// Функция для добавления обработчиков событий к строке
function addEventListenersToRow(row) {
    const editButton = row.querySelector('.edit-room');
    const deleteButton = row.querySelector('.delete-room');
    
    editButton.addEventListener('click', function() {
        const id = this.getAttribute('data-id');
        const number = this.getAttribute('data-number');
        const capacity = this.getAttribute('data-capacity');
        const description = this.getAttribute('data-description');
        
        document.getElementById('editRoomId').value = id;
        document.getElementById('editRoomNumber').value = number;
        document.getElementById('editRoomCapacity').value = capacity;
        document.getElementById('editRoomDescription').value = description;
        
        const modal = new bootstrap.Modal(document.getElementById('editRoomModal'));
        animateModal(modal, 'show');
        modal.show();
    });
    
    deleteButton.addEventListener('click', function() {
        const id = this.getAttribute('data-id');
        deleteRoom(id);
    });
}

// Добавление нового кабинета
document.getElementById('addRoomForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const number = document.getElementById('roomNumber').value;
    const capacity = document.getElementById('roomCapacity').value;
    const description = document.getElementById('roomDescription').value;

    try {
        const response = await fetch('/api/rooms', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                number,
                capacity: parseInt(capacity),
                description
            })
        });

        const data = await response.json();

        if (response.ok) {
            showToast('Кабинет успешно добавлен');
            document.getElementById('addRoomForm').reset();
            
            // Анимация добавления новой строки
            const newRow = document.createElement('tr');
            newRow.className = 'room-row animate__animated animate__fadeIn';
            newRow.innerHTML = `
                <td>${number}</td>
                <td>${capacity}</td>
                <td>${description}</td>
                <td>
                    <button class="btn btn-sm btn-primary me-2 edit-room" 
                            data-id="${data.id}" 
                            data-number="${number}" 
                            data-capacity="${capacity}" 
                            data-description="${description}">
                        Редактировать
                    </button>
                    <button class="btn btn-sm btn-danger delete-room" data-id="${data.id}">
                        Удалить
                    </button>
                </td>
            `;
            document.getElementById('roomsTableBody').appendChild(newRow);
            
            // Добавляем обработчики для новых кнопок
            addEventListenersToRow(newRow);
        } else {
            showToast(data.detail || 'Ошибка при добавлении кабинета', 'error');
        }
    } catch (error) {
        console.error('Error adding room:', error);
        showToast('Ошибка при добавлении кабинета', 'error');
    }
});

// Сохранение изменений кабинета
document.getElementById('saveRoomEdit').addEventListener('click', async () => {
    const id = document.getElementById('editRoomId').value;
    const number = document.getElementById('editRoomNumber').value;
    const capacity = document.getElementById('editRoomCapacity').value;
    const description = document.getElementById('editRoomDescription').value;

    try {
        const response = await fetch(`/api/rooms/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                number,
                capacity: parseInt(capacity),
                description
            })
        });

        const data = await response.json();

        if (response.ok) {
            showToast('Кабинет успешно обновлен');
            
            // Анимация обновления строки
            const row = document.querySelector(`[data-id="${id}"]`).closest('tr');
            await animateUpdateRow(row);
            
            // Обновляем данные в строке
            row.cells[0].textContent = number;
            row.cells[1].textContent = capacity;
            row.cells[2].textContent = description;
            row.querySelector('.edit-room').setAttribute('data-number', number);
            row.querySelector('.edit-room').setAttribute('data-capacity', capacity);
            row.querySelector('.edit-room').setAttribute('data-description', description);

            // Закрываем модальное окно после обновления данных
            const modal = bootstrap.Modal.getInstance(document.getElementById('editRoomModal'));
            modal.hide();
        } else {
            showToast(data.detail || 'Ошибка при обновлении кабинета', 'error');
        }
    } catch (error) {
        console.error('Error updating room:', error);
        showToast('Ошибка при обновлении кабинета', 'error');
    }
});

// Удаление кабинета
async function deleteRoom(id) {
    if (!confirm('Вы уверены, что хотите удалить этот кабинет?')) {
        return;
    }
    
    const row = document.querySelector(`[data-id="${id}"]`).closest('tr');
    await animateDeleteRow(row);
    
    try {
        const response = await fetch(`/api/rooms/${id}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            showToast('Кабинет успешно удален');
            row.remove();
        } else {
            const data = await response.json();
            showToast(data.detail || 'Ошибка при удалении кабинета', 'error');
            row.classList.remove('animate__animated', 'animate__fadeOutLeft');
        }
    } catch (error) {
        console.error('Error deleting room:', error);
        showToast('Ошибка при удалении кабинета', 'error');
        row.classList.remove('animate__animated', 'animate__fadeOutLeft');
    }
}

// Загружаем кабинеты при загрузке страницы
document.addEventListener('DOMContentLoaded', loadRooms);
</script>
{% endblock %} 